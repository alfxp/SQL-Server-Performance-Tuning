<html>
<head>
<title>SQL Tuning Demo Scripts</title>
<style>body{font-family:sans-serif;background-color:#525659}.w3c-default{width:900px;padding:20px;background-color:white;margin:auto;min-height:1100px;margin-top:60px;box-shadow:8px 10px 20px #363636}.header{position:absolute;height:48px;display:table;background:#323639;color:#fff;top:0;left:0;width:100%;margin:0 auto;box-shadow:0 2px 2px 0 rgba(0,0,0,0.14),0 1px 5px 0 rgba(0,0,0,0.12),0 3px 1px -2px rgba(0,0,0,0.2)}.title{left:30%;padding-left:300px;display:table-cell;vertical-align:middle;color:#f1f1f1;font-size:1.2em}</style>
</head>
<body>
<div class="header"><span class="title">SQL Tuning Demo Scripts</span></div>
<div class="w3c-default">
        <p>-----------------------------------------<br style="">-- Demo script for Parameter sniffing  --<br style="">-----------------------------------------</p><p>-- Create demo billing table <br style="">DROP TABLE BillingInfo<br style="">go</p><p>CREATE TABLE BillingInfo(<br style=""> ID   INT IDENTITY,<br style=""> BillingDate DATETIME,<br style=""> BillingAmt FLOAT,<br style=""> BillingDesc varchar(500)<br style="">)<br style="">GO </p><p>-- Insert data in billing table <br style="">DECLARE @I INT<br style="">DECLARE @BD INT<br style="">SET @I = 0<br style="">WHILE @I &lt; 1000000<br style="">BEGIN<br style="">  SET @I = @I + 1<br style="">  SET @BD=CAST(RAND()*10000 AS INT)%3650<br style="">  INSERT BillingInfo (BillingDate, BillingAmt)<br style="">  VALUES (DATEADD(DD,@BD,<br style="">    CAST('1999/01/01' AS DATETIME)),<br style="">    RAND()*5000)<br style="">END<br style="">GO</p><p>select count(*) from BillingInfo</p><p>-- Create indexes on billing table<br style="">ALTER TABLE BillingInfo ADD  CONSTRAINT [PK_BillingInfo_ID]<br style="">PRIMARY KEY CLUSTERED (ID)<br style="">GO<br style=""> <br style="">CREATE NONCLUSTERED INDEX IX_BillingDate ON dbo.BillingInfo(BillingDate)<br style="">GO</p><p>-- Create stored procedure to select data from billing table<br style="">DROP PROCEDURE [DisplayBillingInfo]<br style="">GO <br style="">CREATE PROC [dbo].[DisplayBillingInfo]<br style="">  @BeginDate DATETIME,<br style="">  @EndDate DATETIME<br style="">AS<br style="">SELECT BillingDate, BillingAmt<br style="">  FROM BillingInfo<br style="">  WHERE BillingDate between @BeginDate AND @EndDate<br style="">GO </p><p><br style=""> <br style="">-- Execute stored procedure after resetting procedure cache (index scan)<br style="">SET STATISTICS IO ON;<br style="">DBCC FREEPROCCACHE;<br style="">EXEC dbo.DisplayBillingInfo<br style="">  @BeginDate = '1999-01-01', <br style="">  @EndDate  = '1999-12-31'; </p><p>-- Re-execute sproc with different parameters.<br style="">EXEC dbo.DisplayBillingInfo<br style="">  @BeginDate = '2005-01-01', <br style="">  @EndDate  = '2005-01-03';<br style="">  </p><p>-- Swapped the order of the two different EXEC statements.  <br style="">-- This way the first EXEC statement now calls the stored procedure using the smaller date range as parameters.  <br style="">-- This short date range will be the one that are sniffed in order to create the compiled execution plan.  <br style="">-- When I run this test, here is the execution plan that each stored procedure execution will use:</p><p><br style="">-- Execute sproc with different parameters (index seek)<br style="">SET STATISTICS IO ON;<br style="">DBCC FREEPROCCACHE;<br style="">EXEC dbo.DisplayBillingInfo<br style="">  @BeginDate = '2005-01-01', <br style="">  @EndDate  = '2005-01-03';<br style=""> </p><p>-- Re-execute sproc with different parameters.<br style="">EXEC dbo.DisplayBillingInfo<br style="">  @BeginDate = '1999-01-01', <br style="">  @EndDate  = '1999-12-31'; </p><p>-- Action<br style="">-- RECOMPILE at procedure level </p><p>DROP PROC [dbo].[DisplayBillingInfo]<br style="">GO<br style="">CREATE PROC [dbo].[DisplayBillingInfo]<br style="">  @BeginDate DATETIME,<br style="">  @EndDate DATETIME<br style="">WITH RECOMPILE<br style="">AS<br style="">SELECT BillingDate, BillingAmt<br style="">  FROM BillingInfo<br style="">  WHERE BillingDate between @BeginDate AND @EndDate; <br style="">GO</p><p>-- Index seek<br style="">  DBCC FREEPROCCACHE;<br style="">EXEC dbo.DisplayBillingInfo<br style="">  @BeginDate = '2005-01-01', <br style="">  @EndDate  = '2005-01-03';<br style=""> </p><p>-- Index scan<br style="">EXEC dbo.DisplayBillingInfo<br style="">  @BeginDate = '1999-01-01', <br style="">  @EndDate  = '1999-12-31';</p><p>-- RECOMPILE at query level </p><p>DROP PROC [dbo].[DisplayBillingInfo]<br style="">GO<br style="">CREATE PROC [dbo].[DisplayBillingInfo]<br style="">  @BeginDate DATETIME,<br style="">  @EndDate DATETIME<br style="">WITH RECOMPILE<br style="">AS<br style="">DECLARE @StartDate DATETIME;<br style="">DECLARE @StopDate DATETIME;<br style="">SET @StartDate = @BeginDate;<br style="">SET @StopDate = @EndDate;<br style="">SELECT BillingDate, BillingAmt<br style="">  FROM BillingInfo<br style="">  WHERE BillingDate between @StartDate AND @StopDate<br style="">  OPTION (RECOMPILE)<br style="">GO  </p><p>-- Index seek<br style="">  DBCC FREEPROCCACHE;<br style="">EXEC dbo.DisplayBillingInfo<br style="">  @BeginDate = '2005-01-01', <br style="">  @EndDate  = '2005-01-03';<br style=""> </p><p>-- Index scan<br style="">EXEC dbo.DisplayBillingInfo<br style="">  @BeginDate = '1999-01-01', <br style="">  @EndDate  = '1999-12-31';</p>
    </div>
</div>

</div>
<body>
</html>