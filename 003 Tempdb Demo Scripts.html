<html>
<head>
<title>Tempdb Demo Scripts</title>
<style>body{font-family:sans-serif;background-color:#525659}.w3c-default{width:900px;padding:20px;background-color:white;margin:auto;min-height:1100px;margin-top:60px;box-shadow:8px 10px 20px #363636}.header{position:absolute;height:48px;display:table;background:#323639;color:#fff;top:0;left:0;width:100%;margin:0 auto;box-shadow:0 2px 2px 0 rgba(0,0,0,0.14),0 1px 5px 0 rgba(0,0,0,0.12),0 3px 1px -2px rgba(0,0,0,0.2)}.title{left:30%;padding-left:300px;display:table-cell;vertical-align:middle;color:#f1f1f1;font-size:1.2em}</style>
</head>
<body>
<div class="header"><span class="title">Tempdb Demo Scripts</span></div>
<div class="w3c-default">
        <p>------------------------------------------------------------------------<br style="">-- Tempdb : Find out space used by user objects --<br style="">--<br style="">--User table and index (created explicitly in tempdb)<br style="">--Global temporary table and index<br style="">--Local temporary table and index<br style="">--Table variable<br style="">------------------------------------------------------------------------<br style="">select convert(numeric(10,2),round(sum(data_pages)*8/1024.,2)) as user_object_reserved_MB<br style="">from tempdb.sys.allocation_units a<br style="">inner join tempdb.sys.partitions b on a.container_id = b.partition_id<br style="">inner join tempdb.sys.objects c on b.object_id = c.object_id</p><p><br style="">select * from tempdb.sys.objects<br style="">select * from tempdb.sys.allocation_units</p><p><br style="">drop table [#TABLE1]</p><p>CREATE TABLE [dbo].[#TABLE1] <br style="">([col1] [int] NOT NULL,[col2] [int] NULL,[col3] [int] NULL,[col4] [varchar](50) NULL)<br style="">GO</p><p>-- Populate tables<br style="">DECLARE @val INT<br style="">SELECT @val=1<br style="">WHILE @val &lt; 1000<br style="">BEGIN  <br style="">   INSERT INTO dbo.#Table1(col1, col2, col3, col4) VALUES(@val,@val,@val,'TEST')<br style="">   SELECT @val=@val+1<br style="">END<br style="">GO</p><p><br style="">select * <br style="">from tempdb.sys.allocation_units a<br style="">inner join tempdb.sys.partitions b on a.container_id = b.partition_id<br style="">inner join tempdb.sys.objects c on b.object_id = c.object_id</p><p><br style="">------------------------------------------------------------------------<br style="">-- Tempdb : Find out space used by Internal Objects --<br style="">--<br style="">--Work tables<br style="">----Spooling, to hold intermediate results during a large query<br style="">----DBCC CHECKDB or DBCC CHECKTABLE<br style="">----Temporary large object storage (LOB)<br style="">----Processing SQL Service Broker Objects<br style="">----Common table expression<br style="">----Keyset-driven and static cursors</p><p>--Work files<br style="">----Hash join or hash aggregate operations<br style="">----Sort units</p><p>--ORDER BY, GROUP BY, UNION queries<br style="">----Index rebuilt or creation (with sort in tempdb is specified)</p><p>------------------------------------------------------------------------<br style="">select<br style="">reserved_MB=(unallocated_extent_page_count+version_store_reserved_page_count+user_object_reserved_page_count+internal_object_reserved_page_count+mixed_extent_page_count)*8/1024. ,<br style="">unallocated_extent_MB =unallocated_extent_page_count*8/1024., <br style="">internal_object_reserved_page_count,<br style="">internal_object_reserved_MB =internal_object_reserved_page_count*8/1024.<br style="">from sys.dm_db_file_space_usage</p><p><br style="">------------------------------------------------------------------------<br style="">-- Tempdb : Find out space used for Version Store --<br style="">--<br style="">--Triggers<br style="">--MARS<br style="">--Online Index operation<br style="">--Row versioning-based transaction isolation level<br style="">----Read-committed isolation level (statement-level read consistency)<br style="">----Snapshot isolation level (transaction-level read consistency)<br style="">------------------------------------------------------------------------<br style="">select <br style="">reserved_MB=(unallocated_extent_page_count+version_store_reserved_page_count+user_object_reserved_page_count+internal_object_reserved_page_count+mixed_extent_page_count)*8/1024. ,<br style="">unallocated_extent_MB =unallocated_extent_page_count*8/1024., <br style="">version_store_reserved_page_count,<br style="">version_store_reserved_MB =version_store_reserved_page_count*8/1024.<br style="">from sys.dm_db_file_space_usage</p><p><br style="">------------------------------------------------------------------------<br style="">-- Files details associated with Tempdb.<br style="">------------------------------------------------------------------------<br style="">SELECT<br style="">name AS FileName,<br style="">size*1.0/128 AS FileSizeinMB,<br style="">CASE max_size<br style=""> WHEN 0 THEN 'Autogrowth is off.'<br style=""> WHEN -1 THEN 'Autogrowth is on.'<br style=""> ELSE 'Log file will grow to a maximum size of 2 TB.'<br style="">END AutogrowthStatus,<br style="">growth AS 'GrowthValue',<br style="">'GrowthIncrement' =<br style="">CASE<br style=""> WHEN growth = 0 THEN 'Size is fixed and will not grow.'<br style=""> WHEN growth &gt; 0 AND is_percent_growth = 0 THEN 'Growth value is in 8-KB pages.'<br style=""> ELSE 'Growth value is a percentage.' <br style="">END<br style="">FROM tempdb.sys.database_files;</p><p>-- What is taking space on tempdb<br style="">SELECT <br style="">SUM (user_object_reserved_page_count)*8 as user_obj_kb,<br style="">SUM (internal_object_reserved_page_count)*8 as internal_obj_kb,<br style="">SUM (version_store_reserved_page_count)*8  as version_store_kb,<br style="">SUM (unallocated_extent_page_count)*8 as freespace_kb,<br style="">SUM (mixed_extent_page_count)*8 as mixedextent_kb<br style="">FROM sys.dm_db_file_space_usage</p><p>------------------------------------------------------------<br style="">---    Script to Check TempDB Speed   ---<br style="">------------------------------------------------------------ <br style="">--Are writes being evenly distributed between data files?<br style="">--Are writes finishing in 20ms or less?<br style="">--If the answer is no to either of those questions, weâ€™ve got <br style="">--some performance tuning work to do.<br style="">------------------------------------------------------------- </p><p><br style="">SELECT files.physical_name, files.name, <br style="">  stats.num_of_writes, (1.0 * stats.io_stall_write_ms / stats.num_of_writes) AS avg_write_stall_ms,<br style="">  stats.num_of_reads, (1.0 * stats.io_stall_read_ms / stats.num_of_reads) AS avg_read_stall_ms<br style="">FROM sys.dm_io_virtual_file_stats(2, NULL) as stats<br style="">INNER JOIN master.sys.master_files AS files <br style="">  ON stats.database_id = files.database_id<br style="">  AND stats.file_id = files.file_id<br style="">WHERE files.type_desc = 'ROWS'</p><p>--------------------------------<br style="">-- Tempdb session File usage --<br style="">--------------------------------<br style="">SELECT  sys.dm_exec_sessions.session_id AS [SESSION ID],<br style="">        DB_NAME(sys.dm_db_session_space_usage.database_id) AS [DATABASE Name],<br style="">        HOST_NAME AS [System Name],<br style="">        program_name AS [Program Name],<br style="">        login_name AS [USER Name],<br style="">        status,<br style="">        cpu_time AS [CPU TIME (in milisec)],<br style="">        total_scheduled_time AS [Total Scheduled TIME (in milisec)],<br style="">        total_elapsed_time AS    [Elapsed TIME (in milisec)],<br style="">        (memory_usage * 8)      AS [Memory USAGE (in KB)],<br style="">        (user_objects_alloc_page_count * 8) AS [SPACE Allocated FOR USER Objects (in KB)],<br style="">        (user_objects_dealloc_page_count * 8) AS [SPACE Deallocated FOR USER Objects (in KB)],<br style="">        (internal_objects_alloc_page_count * 8) AS [SPACE Allocated FOR Internal Objects (in KB)],<br style="">        (internal_objects_dealloc_page_count * 8) AS [SPACE Deallocated FOR Internal Objects (in KB)],<br style="">        CASE is_user_process<br style="">   WHEN 1      THEN 'user session'<br style="">            WHEN 0      THEN 'system session'<br style="">        END         AS [SESSION Type], row_count AS [ROW COUNT]<br style="">FROM sys.dm_db_session_space_usage INNER join sys.dm_exec_sessions<br style="">ON sys.dm_db_session_space_usage.session_id = sys.dm_exec_sessions.session_id</p>
    </div>
</div>

</div>
<body>
</html>