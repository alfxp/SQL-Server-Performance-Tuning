<html>
<head>
<title>Index Demo Scripts</title>
<style>body{font-family:sans-serif;background-color:#525659}.w3c-default{width:900px;padding:20px;background-color:white;margin:auto;min-height:1100px;margin-top:60px;box-shadow:8px 10px 20px #363636}.header{position:absolute;height:48px;display:table;background:#323639;color:#fff;top:0;left:0;width:100%;margin:0 auto;box-shadow:0 2px 2px 0 rgba(0,0,0,0.14),0 1px 5px 0 rgba(0,0,0,0.12),0 3px 1px -2px rgba(0,0,0,0.2)}.title{left:30%;padding-left:300px;display:table-cell;vertical-align:middle;color:#f1f1f1;font-size:1.2em}</style>
</head>
<body>
<div class="header"><span class="title">Index Demo Scripts</span></div>
<div class="w3c-default">
        <p>--------------------<br style="">-- Demo 1 Scripts --<br style="">--------------------</p><p>----------------------------<br style="">-- Create Clustered Index --<br style="">----------------------------</p><p>drop table Persons<br style="">go</p><p><br style="">-- Primary Key creation <br style="">CREATE TABLE Persons<br style=""> (<br style=""> P_Id int NOT NULL,<br style=""> LastName varchar(255) NOT NULL,<br style=""> FirstName varchar(255),<br style=""> Address varchar(255),<br style=""> City varchar(255),<br style=""> CONSTRAINT pk_Person PRIMARY KEY (P_Id,LastName )<br style=""> )</p><p> SELECT * FROM sys.indexes WHERE  name = 'pk_Person'</p><p> <br style=""> DROP TABLE Persons<br style=""> GO</p><p> CREATE TABLE Persons<br style=""> (<br style=""> P_Id int NOT NULL,<br style=""> LastName varchar(255) NOT NULL,<br style=""> FirstName varchar(255),<br style=""> Address varchar(255),<br style=""> City varchar(255)<br style=""> )</p><p> ALTER TABLE Persons<br style=""> ADD PRIMARY KEY (P_Id)</p><p> SELECT * FROM sys.indexes WHERE  name like '%person%'</p><p> ALTER TABLE Persons DROP CONSTRAINT  PK__Persons__A3420A5763E624C1 </p><p><br style="">ALTER TABLE Persons<br style="">ADD CONSTRAINT pk_Person PRIMARY KEY (P_Id )</p><p> SELECT * FROM sys.indexes WHERE  name = 'pk_Person'</p><p>--------------------------------<br style="">-- Create Non-Clustered Index --<br style="">---------------------------------<br style="">DROP INDEX  persons.IX_person_name </p><p><br style="">CREATE NONCLUSTERED INDEX IX_person_name <br style="">    ON persons (LastName)<br style="">INCLUDE (FirstName) </p><p><br style="">--------------------------------<br style="">-- Checking index details --<br style="">---------------------------------<br style="">SELECT * FROM sys.indexes WHERE  name = 'IX_person_name'</p><p>SELECT * FROM sys.index_columns WHERE object_id = 1349579846</p><p><br style="">--------------------<br style="">-- Demo 2 Scripts --<br style="">--------------------</p><p>-------------------------------------<br style="">-- Index column Order Demo Script --<br style="">-------------------------------------</p><p><br style="">----------------------------------------------------------------------<br style="">-- Example : Query plan changes with index and Key Look up concept --<br style="">----------------------------------------------------------------------</p><p>DROP TABLE dbo.TABLE1<br style="">GO</p><p>-- Test Table Creation </p><p>CREATE TABLE [dbo].[TABLE1] <br style="">([col1] [int] NOT NULL,[col2] [int] NULL,[col3] [int] NULL,[col4] [varchar](50) NULL)<br style="">GO</p><p>ALTER TABLE dbo.TABLE1 ADD CONSTRAINT PK_TABLE1 PRIMARY KEY CLUSTERED (col1) <br style="">GO</p><p><br style="">-- Populate tables<br style="">DECLARE @val INT<br style="">SELECT @val=1<br style="">WHILE @val &lt; 1000<br style="">BEGIN  <br style="">   INSERT INTO dbo.Table1(col1, col2, col3, col4) VALUES(@val,@val,@val,'TEST')<br style="">   SELECT @val=@val+1<br style="">END<br style="">GO</p><p>-- Create multi-column index on table1<br style="">CREATE NONCLUSTERED INDEX IX_TABLE1_col2col3 ON dbo.TABLE1 (col2,col3)<br style="">  WITH (STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, <br style="">        ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) <br style="">  ON [PRIMARY]<br style="">GO</p><p><br style="">DBCC DROPCLEANBUFFERS<br style="">GO<br style="">SET STATISTICS IO ON<br style="">SELECT * FROM dbo.TABLE1 WHERE col1=88<br style="">SET STATISTICS IO OFF<br style="">GO</p><p><br style="">DBCC DROPCLEANBUFFERS<br style="">GO<br style="">SET STATISTICS IO ON<br style="">SELECT * FROM dbo.TABLE1 WHERE col2=88<br style="">SET STATISTICS IO OFF<br style="">GO</p><p>------------------------------------------<br style="">-- Example 2 : I/O Cost with column order <br style="">------------------------------------------</p><p>DROP TABLE dbo.TABLE2<br style="">GO</p><p>CREATE TABLE [dbo].[TABLE2] <br style="">([col1] [int] NOT NULL,[col2] [int] NULL,[col3] [int] NULL,[col4] [varchar](50) NULL)<br style="">GO</p><p>CREATE INDEX idx_Test ON TABLE2 (Col2, Col1, Col3)<br style="">GO</p><p><br style="">-- Populate tables<br style="">DECLARE @val INT<br style="">SELECT @val=1<br style="">WHILE @val &lt; 1000<br style="">BEGIN  <br style="">   INSERT INTO dbo.Table2(col1, col2, col3, col4) VALUES(@val,@val,@val,'TEST')<br style="">   SELECT @val=@val+1<br style="">END<br style="">GO</p><p>SET STATISTICS IO ON</p><p>SELECT 1<br style="">FROM dbo.Table2<br style="">WHERE Col1 = 12<br style="">AND Col2 = 12<br style="">AND Col3 = 12<br style=""> <br style="">SELECT 1<br style="">FROM dbo.Table2<br style="">WHERE Col3 = 12</p><p>SET STATISTICS IO OFF </p><p><br style="">------------------------<br style="">--- Un-used Indexes  ---<br style="">------------------------</p><p>SELECT OBJECT_SCHEMA_NAME(i.object_id) AS SchemaName ,<br style="">OBJECT_NAME(i.object_id) AS TableName ,<br style="">i.name ,<br style="">ius.user_seeks ,<br style="">ius.user_scans ,<br style="">ius.user_lookups ,<br style="">ius.user_updates<br style="">FROM sys.dm_db_index_usage_stats AS ius<br style="">JOIN sys.indexes AS i ON i.index_id = ius.index_id<br style="">AND i.object_id = ius.object_id<br style="">WHERE ius.database_id = DB_ID()<br style="">AND i.is_unique_constraint = 0 -- no unique indexes<br style="">AND i.is_primary_key = 0<br style="">AND i.is_disabled = 0<br style="">AND i.type &gt; 1 -- don't consider heaps/clustered index<br style="">AND ( ( ius.user_seeks + ius.user_scans +<br style="">ius.user_lookups ) &lt; ius.user_updates<br style="">OR ( ius.user_seeks = 0<br style="">AND ius.user_scans = 0<br style="">)<br style="">)</p><p>-- More information about (all) indexes<br style="">-- we can filer out data for the un-used indexes based on last_user_seek / last_user_scan</p><p>SELECT d.name AS 'database name', t.name AS 'table name', i.name AS 'index name', ius.*<br style=""> FROM sys.dm_db_index_usage_stats ius<br style=""> JOIN sys.databases d ON d.database_id = ius.database_id AND ius.database_id=db_id()<br style=""> JOIN sys.tables t ON t.object_id = ius.object_id<br style=""> JOIN sys.indexes i ON i.object_id = ius.object_id AND i.index_id = ius.index_id<br style=""> ORDER BY user_updates DESC</p><p><br style="">------------------------<br style="">--- Missing Indexes  ---<br style="">------------------------</p><p>SELECT migs.avg_total_user_cost * ( migs.avg_user_impact / 100.0 )<br style="">* ( migs.user_seeks + migs.user_scans ) AS improvement_measure ,<br style="">'CREATE INDEX [missing_index_'<br style="">+ CONVERT (VARCHAR, mig.index_group_handle) + '_'<br style="">+ CONVERT (VARCHAR, mid.index_handle) + '_'<br style="">+ LEFT(PARSENAME(mid.statement, 1), 32) + ']' + ' ON '<br style="">+ mid.statement<br style="">+ ' (' + ISNULL(mid.equality_columns, '')<br style="">+ CASE WHEN mid.equality_columns IS NOT NULL<br style="">AND mid.inequality_columns IS NOT NULL THEN ','<br style="">ELSE ''<br style="">END + ISNULL(mid.inequality_columns, '') + ')'<br style="">+ ISNULL(' INCLUDE ('<br style="">+ mid.included_columns<br style="">+ ')', '')<br style="">AS create_index_statement ,<br style="">migs.* ,<br style="">mid.database_id ,<br style="">mid.[object_id]<br style="">FROM sys.dm_db_missing_index_groups mig<br style="">INNER JOIN sys.dm_db_missing_index_group_stats migs<br style="">ON migs.group_handle = mig.index_group_handle<br style="">INNER JOIN sys.dm_db_missing_index_details mid<br style="">ON mig.index_handle = mid.index_handle<br style="">WHERE migs.avg_total_user_cost * ( migs.avg_user_impact / 100.0 )<br style="">* ( migs.user_seeks + migs.user_scans ) &gt; 10<br style="">ORDER BY migs.avg_total_user_cost * migs.avg_user_impact<br style="">* ( migs.user_seeks + migs.user_scans ) DESC</p><p><br style="">-- Another query which gives similar information<br style="">select d.name AS DatabaseName, mid.*<br style="">from sys.dm_db_missing_index_details mid<br style="">join sys.databases d ON mid.database_id=d.database_id</p><p><br style="">----------------------<br style="">--- XML Show Plan ---<br style="">----------------------</p><p>SET SHOWPLAN_XML ON</p><p>SELECT * FROM dbo.TABLE1 WHERE col2=88</p><p><br style="">SET SHOWPLAN_XML OFF</p><p><br style="">--------------------<br style="">-- Demo 3 Scripts --<br style="">--------------------</p><p>-------------------------------------<br style="">-- Index Fragmentation Demo Script --<br style="">-------------------------------------</p><p>SELECT OBJECT_NAME(ind.OBJECT_ID) AS TableName, <br style="">ind.name AS IndexName, indexstats.index_type_desc AS IndexType, <br style="">indexstats.avg_fragmentation_in_percent <br style="">FROM sys.dm_db_index_physical_stats(DB_ID(), NULL, NULL, NULL, NULL) indexstats <br style="">INNER JOIN sys.indexes ind  <br style="">ON ind.object_id = indexstats.object_id <br style="">AND ind.index_id = indexstats.index_id <br style="">WHERE indexstats.avg_fragmentation_in_percent &gt; 30 <br style="">ORDER BY indexstats.avg_fragmentation_in_percent DESC</p><p><br style="">--------------------<br style="">-- Index Rebuild --<br style="">--------------------</p><p>ALTER INDEX PK_TABLE2 ON dbo.TABLE2<br style="">REBUILD;<br style="">GO</p><p>-- Rebuild all indexes on the table.<br style="">ALTER INDEX ALL ON dbo.TABLE1<br style="">REBUILD WITH (FILLFACTOR = 80, SORT_IN_TEMPDB = ON,<br style="">              STATISTICS_NORECOMPUTE = ON);<br style="">GO</p><p><br style="">-----------------------<br style="">-- Index Reorganize --<br style="">-----------------------<br style="">ALTER INDEX PK_TABLE2 ON dbo.TABLE2<br style="">REORGANIZE ; <br style="">GO</p><p>-- Reorganize all indexes on the table.<br style="">ALTER INDEX ALL ON dbo.TABLE1<br style="">REORGANIZE ; <br style="">GO</p>
    </div>
</div>

</div>
<body>
</html>