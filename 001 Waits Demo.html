<html>
<head>
<title>Waits Demo</title>
<style>body{font-family:sans-serif;background-color:#525659}.w3c-default{width:900px;padding:20px;background-color:white;margin:auto;min-height:1100px;margin-top:60px;box-shadow:8px 10px 20px #363636}.header{position:absolute;height:48px;display:table;background:#323639;color:#fff;top:0;left:0;width:100%;margin:0 auto;box-shadow:0 2px 2px 0 rgba(0,0,0,0.14),0 1px 5px 0 rgba(0,0,0,0.12),0 3px 1px -2px rgba(0,0,0,0.2)}.title{left:30%;padding-left:300px;display:table-cell;vertical-align:middle;color:#f1f1f1;font-size:1.2em}</style>
</head>
<body>
<div class="header"><span class="title">Waits Demo</span></div>
<div class="w3c-default">
        <p>-----------------<br style="">-- Waits Demo --<br style="">-----------------</p><p>-- Query 1 : This queries the sys.dm_os_waiting_tasks DMV to show all waiting tasks currently active or blocked, <br style="">--           revealing the wait type, duration, and resource</p><p>SELECT  blocking.session_id AS blocking_session_id ,        <br style="">  blocked.session_id AS blocked_session_id ,        <br style="">  waitstats.wait_type AS blocking_resource ,        <br style="">  waitstats.wait_duration_ms ,        <br style="">  waitstats.resource_description ,        <br style="">  blocked_cache.text AS blocked_text ,        <br style="">  blocking_cache.text AS blocking_text <br style="">FROM    sys.dm_exec_connections AS blocking       <br style="">INNER JOIN sys.dm_exec_requests blocked   ON blocking.session_id = blocked.blocking_session_id        <br style="">CROSS APPLY sys.dm_exec_sql_text(blocked.sql_handle)  blocked_cache        <br style="">CROSS APPLY sys.dm_exec_sql_text(blocking.most_recent_sql_handle) blocking_cache        <br style="">INNER JOIN sys.dm_os_waiting_tasks waitstats  ON waitstats.session_id = blocked.session_id</p><p>-- Query 2: Determine if CPU is under pressure<br style="">-- The sys.dm_os_wait_stats DMV shows aggregated wait times and counts starting from when the wait statistics were cleared, or from when the server starte<br style="">SELECT  SUM(signal_wait_time_ms) AS TotalSignalWaitTime ,        <br style="">       ( SUM(CAST(signal_wait_time_ms AS NUMERIC(20, 2))) / SUM(CAST(wait_time_ms AS NUMERIC(20, 2))) * 100 ) AS PercentageSignalWaitsOfTotalTime <br style="">    FROM    sys.dm_os_wait_stats</p><p>-- Clear the wait stats data manually.<br style="">DBCC SQLPERF ('sys.dm_os_wait_stats', CLEAR)</p><p>-- Query 3: This DMV returns one row for each of the SQL Server schedulers and it lists the total number of tasks <br style="">--  that are assigned to each scheduler, as well as the number that are runnable. <br style="">--  below 255 is system processes like backcup, etc.<br style="">SELECT  scheduler_id ,       <br style="">        current_tasks_count ,        <br style="">  runnable_tasks_count <br style="">FROM    sys.dm_os_schedulers <br style="">WHERE   scheduler_id &lt; 255</p><p><br style="">--  Query 4: primary resource waits<br style=""> WITH [Waits] AS<br style="">(SELECT<br style="">    [wait_type],<br style="">    [wait_time_ms] / 1000.0 AS [Wait Time (sec)],<br style="">    ([wait_time_ms] - [signal_wait_time_ms]) / 1000.0 AS [Resource (sec)],<br style="">    [signal_wait_time_ms] / 1000.0 AS [Signal (sec)],<br style="">    [waiting_tasks_count] AS [WaitCount],<br style="">    100.0 * [wait_time_ms] / SUM ([wait_time_ms]) OVER() AS [Percentage],<br style="">    ROW_NUMBER() OVER(ORDER BY [wait_time_ms] DESC) AS [RowNum]<br style="">FROM sys.dm_os_wait_stats<br style="">WHERE [wait_type] NOT IN (<br style="">    N'BROKER_EVENTHANDLER',          N'BROKER_RECEIVE_WAITFOR',<br style="">    N'BROKER_TASK_STOP',             N'BROKER_TO_FLUSH',<br style="">    N'BROKER_TRANSMITTER',           N'CHECKPOINT_QUEUE',<br style="">    N'CHKPT',                        N'CLR_AUTO_EVENT',<br style="">    N'CLR_MANUAL_EVENT',             N'CLR_SEMAPHORE',<br style="">    N'DBMIRROR_DBM_EVENT',           N'DBMIRROR_EVENTS_QUEUE',<br style="">    N'DBMIRROR_WORKER_QUEUE',        N'DBMIRRORING_CMD',<br style="">    N'DIRTY_PAGE_POLL',              N'DISPATCHER_QUEUE_SEMAPHORE',<br style="">    N'EXECSYNC',                     N'FSAGENT',<br style="">    N'FT_IFTS_SCHEDULER_IDLE_WAIT',  N'FT_IFTSHC_MUTEX',<br style="">    N'HADR_CLUSAPI_CALL',            N'HADR_FILESTREAM_IOMGR_IOCOMPLETION',<br style="">    N'HADR_LOGCAPTURE_WAIT',         N'HADR_NOTIFICATION_DEQUEUE',<br style="">    N'HADR_TIMER_TASK',              N'HADR_WORK_QUEUE',<br style="">    N'KSOURCE_WAKEUP',               N'LAZYWRITER_SLEEP',<br style="">    N'LOGMGR_QUEUE',                 N'ONDEMAND_TASK_QUEUE',<br style="">    N'PWAIT_ALL_COMPONENTS_INITIALIZED',<br style="">    N'QDS_PERSIST_TASK_MAIN_LOOP_SLEEP',<br style="">    N'QDS_CLEANUP_STALE_QUERIES_TASK_MAIN_LOOP_SLEEP',<br style="">    N'REQUEST_FOR_DEADLOCK_SEARCH',  N'RESOURCE_QUEUE',<br style="">    N'SERVER_IDLE_CHECK',            N'SLEEP_BPOOL_FLUSH',<br style="">    N'SLEEP_DBSTARTUP',              N'SLEEP_DCOMSTARTUP',<br style="">    N'SLEEP_MASTERDBREADY',          N'SLEEP_MASTERMDREADY',<br style="">    N'SLEEP_MASTERUPGRADED',         N'SLEEP_MSDBSTARTUP',<br style="">    N'SLEEP_SYSTEMTASK',             N'SLEEP_TASK',<br style="">    N'SLEEP_TEMPDBSTARTUP',          N'SNI_HTTP_ACCEPT',<br style="">    N'SP_SERVER_DIAGNOSTICS_SLEEP',  N'SQLTRACE_BUFFER_FLUSH',<br style="">    N'SQLTRACE_INCREMENTAL_FLUSH_SLEEP',<br style="">    N'SQLTRACE_WAIT_ENTRIES',        N'WAIT_FOR_RESULTS',<br style="">    N'WAITFOR',                      N'WAITFOR_TASKSHUTDOWN',<br style="">    N'WAIT_XTP_HOST_WAIT',           N'WAIT_XTP_OFFLINE_CKPT_NEW_LOG',<br style="">    N'WAIT_XTP_CKPT_CLOSE',          N'XE_DISPATCHER_JOIN',<br style="">    N'XE_DISPATCHER_WAIT',           N'XE_TIMER_EVENT')<br style="">)<br style="">SELECT<br style="">    [W1].[wait_type] AS [WaitType],<br style="">    [W1].[Wait Time (sec)],<br style="">    [W1].[Resource (sec)],<br style="">    [W1].[Signal (sec)],<br style="">    [W1].[WaitCount],<br style="">    [W1].[Percentage],<br style="">    [W1].[Wait Time (sec)] / [W1].[WaitCount] as [Mean Wait Time (sec)],<br style="">    [W1].[Resource (sec)] / [W1].[WaitCount] as [Mean Resource Wait (sec)],<br style="">    [W1].[Signal (sec)] / [W1].[WaitCount] as [Mean Signal Wait (sec)]<br style="">FROM [Waits] AS [W1]<br style="">INNER JOIN [Waits] AS [W2]<br style="">    ON [W2].[RowNum] &lt;= [W1].[RowNum]<br style="">GROUP BY [W1].[RowNum], [W1].[wait_type], [W1].[Wait Time (sec)],<br style="">         [W1].[Resource (sec)], [W1].[Signal (sec)], [W1].[WaitCount], [W1].[Percentage]<br style="">HAVING SUM ([W2].[Percentage]) - [W1].[Percentage] &lt; 95; -- percentage threshold</p><p>-- Query 5: IO waits details (which database / datafiles get mist read / writes).<br style="">SELECT  DB_NAME(vfs.database_id) AS database_name ,       <br style="">   vfs.database_id ,        <br style="">   vfs.file_id ,        <br style="">   io_stall_read_ms / NULLIF(num_of_reads, 0) AS avg_read_latency ,        <br style="">   io_stall_write_ms / NULLIF(num_of_writes, 0) AS avg_write_latency ,        <br style="">   io_stall_write_ms / NULLIF(num_of_writes + num_of_writes, 0)  AS avg_total_latency ,        <br style="">   num_of_bytes_read / NULLIF(num_of_reads, 0)  AS avg_bytes_per_read ,        <br style="">   num_of_bytes_written / NULLIF(num_of_writes, 0) AS avg_bytes_per_write ,       <br style="">   vfs.io_stall ,        <br style="">   vfs.num_of_reads ,       <br style="">   vfs.num_of_bytes_read ,       <br style="">   vfs.io_stall_read_ms ,       <br style="">   vfs.num_of_writes ,        <br style="">   vfs.num_of_bytes_written ,       <br style="">   vfs.io_stall_write_ms ,       <br style="">   size_on_disk_bytes / 1024 / 1024. AS size_on_disk_mbytes ,       <br style="">   physical_name <br style="">FROM    sys.dm_io_virtual_file_stats(NULL, NULL) AS vfs       <br style=""> JOIN sys.master_files AS mf ON vfs.database_id = mf.database_id  AND vfs.file_id = mf.file_id<br style=""> ORDER BY avg_total_latency DESC</p>
    </div>
</div>

</div>
<body>
</html>